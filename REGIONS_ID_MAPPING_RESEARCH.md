# Исследование сопоставления ID регионов на russiabase.ru

## Проблема

При первоначальной реализации парсера использовались неправильные названия регионов. Было обнаружено, что ID регионов на russiabase.ru не соответствуют стандартной нумерации ОКАТО или другим официальным кодам.

## Результаты исследования

### Тестированные ID и реальные названия

| ID | Ожидалось | Реальное название на russiabase.ru |
|---|-----------|-------------------------------------|
| 1 | Москва | Тверская область |
| 2 | Санкт-Петербург | Калининградская область |
| 3 | Новосибирск | Псковская область |
| 4 | Екатеринбург | Ленинградская область |
| 5 | Нижний Новгород | Республика Карелия |
| 10 | Казань | Ямало-Ненецкий автономный округ |
| 16 | - | Республика Татарстан |
| 20 | Ростов | Тюменская область |
| 23 | - | Краснодарский край |
| 25 | Воронеж | Оренбургская область |
| 30 | Краснодар | Тульская область |
| 35 | Самара | Удмуртская Республика |
| 40 | - | Курская область |
| 45 | Уфа | Республика Мордовия |
| 50 | Пермь | Тамбовская область |
| 77 | - | Чукотский автономный округ |
| 78 | - | Камчатский край |

## Выводы

1. **ID регионов на russiabase.ru - внутренняя нумерация сайта**, не связанная с официальными кодами
2. **Невозможно предсказать название региона по ID** без обращения к сайту
3. **Необходимо извлекать название региона с каждой страницы** через HTML парсинг

## Решение

### Метод извлечения названий регионов

Реализован метод `_extract_region_name()` с несколькими стратегиями:

1. **Извлечение из тега `<title>`**
   ```html
   <title>Цены на бензин сегодня в Курской области</title>
   ```
   → "Курской области" → "Курская область"

2. **Извлечение из тега `<h1>`**
   ```html
   <h1>Сколько стоит бензин сегодня в Курской области</h1>
   ```
   → "Курской области" → "Курская область"

3. **Извлечение из мета-описания**
   ```html
   <meta name="description" content="Актуальная стоимость бензина на сегодня в Курской области...">
   ```

### Нормализация названий регионов

Создана функция `_normalize_region_name()` которая:

- **Преобразует падежные формы** в именительный падеж
- **Поддерживает все типы субъектов РФ**:
  - Области: "Курской области" → "Курская область"
  - Республики: "Карелии" → "Республика Карелия"
  - Края: "Краснодарском крае" → "Краснодарский край"
  - Автономные округа: "Чукотке" → "Чукотский автономный округ"
  - Города: "Москве" → "Москва"

## Код решения

```python
def _extract_region_name(self, html_content: str, region_id: int) -> str:
    """Извлекает правильное название региона со страницы russiabase.ru"""
    try:
        soup = BeautifulSoup(html_content, 'html.parser')
        
        # Стратегия 1: Извлечение из title
        title = soup.find('title')
        if title:
            title_text = title.get_text().strip()
            if ' в ' in title_text:
                region_name = title_text.split(' в ')[-1].strip()
                region_name = self._normalize_region_name(region_name)
                if region_name:
                    return region_name
        
        # Стратегия 2: Извлечение из H1
        h1 = soup.find('h1')
        if h1:
            h1_text = h1.get_text().strip()
            if ' в ' in h1_text:
                region_name = h1_text.split(' в ')[-1].strip()
                region_name = self._normalize_region_name(region_name)
                if region_name:
                    return region_name
        
        return f"Регион {region_id}"
        
    except Exception as e:
        logger.warning(f"Ошибка извлечения названия региона {region_id}: {e}")
        return f"Регион {region_id}"
```

## Результат

Теперь парсер корректно извлекает реальные названия регионов:

```
✅ ID 40: Курская область
✅ ID 77: Чукотский автономный округ  
✅ ID 78: Камчатский край
```

Вместо неправильных названий из статических словарей.

## Рекомендации для будущего развития

1. **Построить полную карту ID → Название** через массовый парсинг всех доступных страниц
2. **Кешировать названия регионов** для избежания повторных запросов
3. **Мониторить изменения** в структуре сайта для поддержания актуальности парсинга
4. **Создать резервные стратегии** извлечения названий при изменении HTML структуры