# Архитектура проекта парсинга цен АЗС

## Обзор архитектуры

Проект построен на принципах модульности, расширяемости и единообразия. Основная идея - создать гибкую систему, которая может легко адаптироваться к различным источникам данных о ценах на топливо.

## Основные принципы

### 1. Паттерн "Фабрика" (Factory Pattern)
- `ParserFactory` создает нужный тип парсера на основе конфигурации
- Легко добавлять новые типы парсеров без изменения существующего кода

### 2. Паттерн "Стратегия" (Strategy Pattern)
- Различные парсеры (`RussiaBaseParser`, `GazpromParser`, `YandexMapsParser`) реализуют единый интерфейс
- Можно легко переключаться между разными стратегиями парсинга

### 3. Оркестратор (Orchestrator Pattern)
- `GasStationOrchestrator` координирует работу всех парсеров
- Управляет параллельным выполнением и агрегацией результатов

## Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                        main.py                             │
│                    (Точка входа)                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                GasStationOrchestrator                      │
│        (Координация и управление парсерами)                │
├─────────────────────┬───────────────────────────────────────┤
│ • run_sequential()  │ • run_parallel()                      │
│ • _save_data()      │ • get_summary()                       │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                   ParserFactory                            │
│            (Создание парсеров по типу)                     │
└─────┬───────────┬─────────────┬─────────────┬───────────────┘
      │           │             │             │
┌─────▼─────┐ ┌───▼────┐ ┌──────▼─────┐ ┌─────▼──────┐
│BaseParser │ │RussiaB.│ │GazpromPars.│ │YandexMaps. │
│(Базовый)  │ │Parser  │ │er          │ │Parser      │
├───────────┤ ├────────┤ ├────────────┤ ├────────────┤
│• run()    │ │• HTML  │ │• REST API  │ │• Selenium  │
│• normalize│ │• JSON  │ │• JSON      │ │• Browser   │
│• retry()  │ │        │ │            │ │            │
└───────────┘ └────────┘ └────────────┘ └────────────┘
      │           │             │             │
      └─────┬─────┴─────────────┴─────────────┘
            │
┌───────────▼─────────────────────────────────────────────────┐
│                   Единая схема данных                      │
│  station_id | network_name | fuel_type | price | ...       │
└─────────────────────────────────────────────────────────────┘
```

## Структура модулей

### Core модули

#### 1. `config.py`
**Назначение**: Централизованная конфигурация
**Содержит**:
- Настройки сетей АЗС
- Параметры запросов (таймауты, задержки)
- Схему выходных данных
- Headers для HTTP запросов

#### 2. `main.py`
**Назначение**: Точка входа приложения
**Функции**:
- Парсинг аргументов командной строки
- Настройка логирования
- Создание и запуск оркестратора
- Вывод итоговой статистики

### Парсеры (`src/parsers/`)

#### 1. `base.py` - BaseParser
**Назначение**: Абстрактный базовый класс для всех парсеров
**Основные методы**:
```python
@abstractmethod
def fetch_data() -> List[Dict[str, Any]]
@abstractmethod  
def parse_station_data(raw_data) -> List[Dict[str, Any]]
def normalize_data() -> pl.DataFrame
def run() -> pl.DataFrame
```

#### 2. `russiabase_parser.py` - RussiaBaseParser
**Назначение**: Парсинг сайта russiabase.ru
**Особенности**:
- Извлечение JSON-LD данных из HTML
- Поддержка пагинации
- Обработка описаний с ценами топлива
- Используется для: Лукойл, Башнефть

#### 3. `gazprom_parser.py` - GazpromParser
**Назначение**: Парсинг API Газпром Нефть
**Особенности**:
- REST API запросы
- Двухэтапный процесс (список станций → детали)
- Структурированные JSON данные
- Координаты станций

#### 4. `yandex_parser.py` - YandexMapsParser
**Назначение**: Парсинг Яндекс Карт через Selenium
**Особенности**:
- Автоматизация браузера
- Обход JavaScript защиты
- Динамическая прокрутка
- Извлечение данных из DOM

#### 5. `parser_factory.py` - ParserFactory
**Назначение**: Создание парсеров по типу
**Паттерн**: Factory Method
```python
PARSER_MAPPING = {
    "russiabase": RussiaBaseParser,
    "api": GazpromParser, 
    "selenium": YandexMapsParser
}
```

### Управление (`src/`)

#### 1. `orchestrator.py` - GasStationOrchestrator
**Назначение**: Координация всех парсеров
**Возможности**:
- Последовательное выполнение
- Параллельное выполнение с ThreadPoolExecutor
- Агрегация результатов
- Сохранение данных
- Обработка ошибок

#### 2. `utils.py` - DataProcessor & DataValidator
**Назначение**: Утилиты для обработки данных
**Функции**:
- Загрузка и очистка данных
- Статистический анализ
- Поиск дешевых заправок
- Сравнение сетей
- Экспорт отчетов
- Валидация качества данных

## Поток данных

### 1. Инициализация
```
main.py → config.py → GasStationOrchestrator
```

### 2. Создание парсеров
```
Orchestrator → ParserFactory → ConcreteParser
```

### 3. Выполнение парсинга
```
ConcreteParser.run() → fetch_data() → parse_station_data() → normalize_data()
```

### 4. Агрегация результатов
```
Orchestrator → combine DataFrames → save to Excel → generate summary
```

## Схема данных

### Входные данные (различные форматы)
- **RussiaBase**: JSON-LD в HTML
- **Gazprom**: JSON через REST API  
- **Yandex**: HTML через Selenium

### Унифицированная схема (выходные данные)
```python
{
    "station_id": str,      # Уникальный ID станции
    "network_name": str,    # Название сети АЗС
    "station_name": str,    # Название станции
    "address": str,         # Полный адрес
    "city": str,           # Город
    "latitude": float,      # Широта (опционально)
    "longitude": float,     # Долгота (опционально)
    "fuel_type": str,      # Тип топлива (АИ-92, АИ-95, ДТ)
    "price": float,        # Цена за литр
    "currency": str,       # Валюта (RUB)
    "last_updated": str,   # Время обновления
    "source": str          # Источник данных
}
```

## Масштабируемость

### Добавление нового парсера

1. **Создать класс парсера**:
```python
class NewNetworkParser(BaseParser):
    def fetch_data(self): 
        # Логика получения данных
        pass
    
    def parse_station_data(self, raw_data):
        # Логика парсинга
        pass
```

2. **Обновить фабрику**:
```python
_PARSER_MAPPING = {
    "new_type": NewNetworkParser
}
```

3. **Добавить конфигурацию**:
```python
GAS_STATION_NETWORKS["new_network"] = {
    "name": "Новая сеть",
    "type": "new_type",
    "config": {...}
}
```

### Горизонтальное масштабирование

- **Параллельные воркеры**: ThreadPoolExecutor для одновременного парсинга
- **Асинхронность**: Возможность добавления async/await
- **Очереди**: Интеграция с Celery/Redis для фоновых задач
- **Кэширование**: Добавление Redis для кэширования результатов

## Обработка ошибок

### Уровни обработки

1. **Парсер уровень**: `retry_on_failure()` с экспоненциальным backoff
2. **Оркестратор уровень**: Graceful degradation при ошибках отдельных сетей
3. **Приложение уровень**: Общий exception handler в main.py

### Логирование

- **Структурированные логи**: JSON формат для машинной обработки
- **Уровни логирования**: DEBUG, INFO, WARNING, ERROR
- **Ротация логов**: Автоматическая ротация по размеру
- **Контекст**: Включение ID парсера и временных меток

## Безопасность и этика

### Rate Limiting
- Задержки между запросами: `REQUEST_DELAY = (1, 3)`
- Экспоненциальный backoff при ошибках
- Реалистичные User-Agent заголовки

### Соблюдение ToS
- Уважение к robots.txt
- Разумные таймауты
- Мониторинг нагрузки на серверы

## Будущие улучшения

### Техническая дорожная карта

1. **Database интеграция**
   - SQLite/PostgreSQL для хранения исторических данных
   - Миграции схемы данных

2. **Web API**
   - REST API для доступа к данным
   - WebSocket для real-time обновлений

3. **Мониторинг**
   - Prometheus метрики
   - Grafana дашборды
   - Алерты при ошибках

4. **Уведомления**
   - Telegram/email уведомления
   - Webhook интеграции

5. **ML аналитика**
   - Предсказание цен
   - Аномалии в ценах
   - Геоаналитика

## Производительность

### Бенчмарки (примерные)

- **RussiaBase парсер**: ~2-3 сек/страница
- **Gazprom API**: ~1-2 сек/станция  
- **Yandex Selenium**: ~5-10 сек/организация
- **Параллельная обработка**: 2-3x ускорение

### Оптимизации

- Connection pooling для HTTP запросов
- Кэширование промежуточных результатов
- Batch обработка для больших объемов
- Компрессия данных при сохранении