# Руководство по региональному парсеру russiabase.ru

## Обзор

Новый региональный парсер `RussiaBaseRegionalParser` предназначен для сбора данных о ценах на топливо по регионам России с сайта russiabase.ru. В отличие от стандартного парсера, который собирает данные по отдельным АЗС, региональный парсер создает сводную таблицу с данными по регионам.

## Основные возможности

### 1. Структура данных
Парсер создает таблицу со следующими колонками:
- `region_id` - ID региона
- `region_name` - Название региона
- `status` - Статус обработки (success/error)
- `АИ-92` - Цена на бензин АИ-92 (если найдена)
- `АИ-95` - Цена на бензин АИ-95 (если найдена)
- `АИ-98` - Цена на бензин АИ-98 (если найдена)
- `АИ-100` - Цена на бензин АИ-100 (если найдена)
- `Дизель` - Цена на дизельное топливо (если найдена)
- `Газ` - Цена на газ (если найдена)

### 2. Методы извлечения данных
Парсер использует несколько методов для извлечения цен:
- **JSON-LD структуры** - Поиск структурированных данных в script тегах
- **Next.js данные** - Извлечение из `window.__NEXT_DATA__`
- **Регулярные выражения** - Поиск цен в тексте страницы
- **Таблицы HTML** - Парсинг табличных данных

### 3. Поддерживаемые регионы
Парсер работает со всеми регионами из базы регионов проекта, включая:
- Москва (ID: 77)
- Санкт-Петербург (ID: 78)
- Все области, края и республики РФ

## Использование

### Базовый пример

```python
from src.parsers.russiabase_parser import RussiaBaseRegionalParser

# Создание парсера
config = {
    "type": "russiabase_regional",
    "name": "RussiaBase Regional Prices"
}
parser = RussiaBaseRegionalParser("regional_parser", config)

# Сбор данных по всем регионам
data = parser.fetch_data()

# Создание таблицы
df = parser.create_fuel_prices_table(data)
print(df)

# Сохранение в Excel
parser.save_to_excel(data, 'regional_prices.xlsx')
```

### Тестирование одного региона

```python
# Тест для конкретного региона
region_data = parser._fetch_region_data(40, "Курская область")
print(f"Статус: {region_data['status']}")
print(f"Цены: {region_data['fuel_prices']}")
```

### Использование через фабрику

```python
from src.parsers.parser_factory import ParserFactory

# Создание через фабрику
config = {"type": "russiabase_regional"}
parser = ParserFactory.create_parser("regional_prices", config)

# Сбор данных
data = parser.fetch_data()
```

## Запуск тестов

Для тестирования функциональности используйте специальный тестовый скрипт:

```bash
python test_regional_parser.py
```

Тестовый скрипт выполняет:
1. Тест парсинга одного региона (Курская область)
2. Тест парсинга нескольких регионов
3. Создание сводной таблицы
4. Сохранение результатов в Excel файл
5. Вывод статистики

## Структура выходных данных

### Excel файл содержит несколько листов:

1. **Regional_Prices** - Основная таблица с ценами по регионам
2. **Statistics** - Сводная статистика по сбору данных
3. **Errors** - Список ошибок (если есть)

### Пример таблицы:

| region_id | region_name | status | АИ-92 | АИ-95 | Дизель |
|-----------|-------------|--------|-------|-------|--------|
| 77 | Москва | success | 56.50 | 61.20 | 70.30 |
| 78 | Санкт-Петербург | success | 55.80 | 60.90 | 69.50 |
| 40 | Курская область | success | 54.20 | 59.10 | 68.20 |

### Статистика включает:
- Общее количество регионов
- Количество успешно обработанных регионов
- Количество ошибок
- Процент успешности
- Найденные типы топлива

## Обработка ошибок

Парсер устойчив к ошибкам:
- При ошибке загрузки региона, записывается статус 'error'
- Ошибки логируются и сохраняются в отчет
- Обработка продолжается для следующих регионов

## Настройки и конфигурация

### Основные параметры:
- `TIMEOUT` - таймаут запросов (из config.py)
- `DEFAULT_HEADERS` - заголовки HTTP запросов
- Задержки между запросами для предотвращения блокировки

### Логирование:
Парсер использует библиотеку `loguru` для подробного логирования:
- INFO - основные этапы работы
- DEBUG - детальная информация о парсинге
- WARNING - предупреждения о проблемах
- ERROR - ошибки при обработке

## Примеры URL для регионов

Парсер работает с URL вида:
- `https://russiabase.ru/prices?region=77` (Москва)
- `https://russiabase.ru/prices?region=78` (Санкт-Петербург)
- `https://russiabase.ru/prices?region=40` (Курская область)

## Производительность

- Задержка между запросами: ~1-2 секунды
- Время обработки одного региона: ~3-5 секунд
- Полный сбор по всем регионам: ~15-30 минут

## Требования

Убедитесь, что установлены все зависимости:
```bash
pip install -r requirements.txt
```

Основные библиотеки:
- `requests` - HTTP запросы
- `beautifulsoup4` - парсинг HTML
- `pandas` - работа с данными
- `openpyxl` - сохранение в Excel
- `loguru` - логирование

## Интеграция с существующим кодом

Региональный парсер интегрирован в существующую архитектуру:
- Наследует от `BaseParser`
- Зарегистрирован в `ParserFactory`
- Использует общие настройки из `config.py`
- Совместим с системой регионов `src.regions`

## Возможные улучшения

1. **Кэширование данных** - для снижения нагрузки на сервер
2. **Параллельные запросы** - для ускорения сбора данных
3. **Дополнительные типы топлива** - расширение списка поддерживаемых видов
4. **Исторические данные** - сбор и анализ динамики цен
5. **API интеграция** - прямой доступ к данным через API (если появится)

## Поддержка и отладка

При возникновении проблем:
1. Проверьте логи для выявления ошибок
2. Убедитесь в доступности сайта russiabase.ru
3. Проверьте корректность ID регионов
4. Увеличьте таймауты при медленном соединении

Для отладки конкретного региона используйте метод `_fetch_region_data()` напрямую.