# Парсер региональных цен russiabase.ru

## Описание

Парсер для извлечения цен на топливо с сайта russiabase.ru с поддержкой специфичных селекторов для таблиц и эффективной обработкой данных.

## Основные улучшения

### 1. Специфичные селекторы для russiabase.ru

Парсер теперь использует точные селекторы для извлечения данных из таблицы:

- **Основная таблица**: `section.Table_table__QTCkj table.Table_tableInnerWrapper__AGg3H`
- **Заголовки**: `thead tr th` (названия видов топлива)
- **Ячейки с ценами**: `tbody tr td.Table_column__20dGl`

### 2. Улучшенная нормализация названий топлива

Расширенный маппинг названий топлива:
- **АИ-92**: `['ai-92', 'аи-92', 'аи 92', '92', 'ai92', 'АИ-92', 'ай-92', 'ай 92', 'Аи-92+', 'аи92']`
- **АИ-95**: `['ai-95', 'аи-95', 'аи 95', '95', 'ai95', 'АИ-95', 'ай-95', 'ай 95', 'Аи-95+', 'аи95']`
- **АИ-98**: `['ai-98', 'аи-98', 'аи 98', '98', 'ai98', 'АИ-98', 'ай-98', 'ай 98', 'аи98']`
- **АИ-100**: `['ai-100', 'аи-100', 'аи 100', '100', 'ai100', 'АИ-100', 'ай-100', 'ай 100', 'аи100']`
- **ДТ**: `['дизель', 'диз', 'dt', 'дт', 'diesel', 'дизельное', 'ДТ', 'солярка', 'дизтопливо']`
- **Пропан**: `['газ', 'lpg', 'gas', 'суг', 'пропан', 'Пропан', 'сжиженный газ', 'автогаз']`

### 3. Многоуровневая стратегия извлечения

Парсер использует несколько стратегий для максимальной эффективности:

1. **Специальные селекторы russiabase.ru** - приоритетный метод
2. **Общий поиск по таблицам** - резервный метод
3. **JSON данные в скриптах** - для динамического контента
4. **Регулярные выражения** - для нестандартных форматов
5. **CSS селекторы** - для альтернативной разметки

## Использование

### Быстрый запуск

```bash
# Запуск парсера
python regional_parser.py --popular-regions

# Запуск тестирования
python test_updated_parser.py
```

### Программное использование

```python
from src.parsers.russiabase_parser import RussiaBaseRegionalParser
from src.regions import RegionManager

# Создание парсера
parser = RussiaBaseRegionalParser(delay=1.5)
region_manager = RegionManager()

# Получение цен для конкретного региона
result = parser.get_region_prices(56, "Краснодарский край")

if result and result.fuel_prices:
    print(f"Регион: {result.region_name}")
    print("Цены:")
    for fuel_type, price in result.fuel_prices.items():
        print(f"  {fuel_type}: {price:.2f} руб/л")
```

### Пример работы с классом RegionalPriceAnalyzer

```python
from regional_prices_final import RegionalPriceAnalyzer

# Создание анализатора
analyzer = RegionalPriceAnalyzer()

# Получение цен для одного региона
region_data = analyzer.get_prices_for_region(56)  # Краснодарский край

# Получение цен для нескольких регионов
key_regions = [77, 78, 50, 23]  # Москва, СПб, МО, Краснодарский край
multiple_data = analyzer.get_prices_for_multiple_regions(key_regions)

# Сохранение результатов
analyzer.save_to_json(multiple_data, "prices.json")
analyzer.save_to_csv(multiple_data, "prices.csv")

# Вывод сводной таблицы
analyzer.print_summary_table(multiple_data)
```

## Структура данных

### Формат результата для одного региона

```json
{
  "region_id": 56,
  "region_name": "Краснодарский край",
  "prices": {
    "АИ-92": 58.16,
    "АИ-95": 59.12,
    "АИ-98": 64.19,
    "АИ-100": 65.65,
    "ДТ": 67.34,
    "Пропан": 29.15
  },
  "timestamp": "2024-01-15 14:30:22",
  "status": "success"
}
```

### CSV формат

```csv
region_id,region_name,timestamp,status,АИ-92,АИ-95,АИ-98,АИ-100,ДТ,Пропан
56,Краснодарский край,2024-01-15 14:30:22,success,58.16,59.12,64.19,65.65,67.34,29.15
77,Москва,2024-01-15 14:31:25,success,60.2,61.8,67.5,69.2,70.1,31.5
```

## Особенности работы с таблицами

### Алгоритм извлечения данных

1. **Поиск основной таблицы** по селектору `table.Table_tableInnerWrapper__AGg3H`
2. **Извлечение заголовков** из `thead tr th` для определения видов топлива
3. **Поиск строки с ценами** - ищет строки со средними ценами или первые строки с числовыми данными
4. **Сопоставление данных** - соотносит заголовки с ценами по позиции
5. **Резервные методы** - если основной метод не работает, использует альтернативные стратегии

### Обработка ошибок

- **Таймауты запросов**: 30 секунд
- **Повторные попытки**: автоматические для сетевых ошибок  
- **Валидация цен**: проверка диапазона 10-200 руб/л
- **Логирование**: подробная информация о процессе парсинга

## Файлы проекта

### Основные компоненты

- `src/parsers/russiabase_parser.py` - основной парсер
- `src/regions.py` - менеджер регионов
- `regional_parser.py` - скрипт для работы с парсером
- `test_updated_parser.py` - скрипт тестирования

### Вспомогательные файлы

- `config.py` - конфигурация
- `requirements.txt` - зависимости
- `regions.md` - список регионов

## Требования

```txt
requests>=2.31.0
beautifulsoup4>=4.12.0
lxml>=4.9.0
loguru>=0.7.0
```

## Запуск тестов

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск тестирования парсера
python test_updated_parser.py

# Запуск парсера
python regional_parser.py --popular-regions
```

## Производительность

- **Задержка между запросами**: 1.5 секунды (настраивается)
- **Время парсинга одного региона**: ~2-3 секунды
- **Обработка 10 регионов**: ~20-30 секунд
- **Использование памяти**: ~50-100 МБ

## Логирование

Парсер ведет подробные логи:

```
2024-01-15 14:30:22 - INFO - Парсинг региона: Краснодарский край (ID: 56)
2024-01-15 14:30:23 - DEBUG - Найдена основная таблица russiabase.ru
2024-01-15 14:30:23 - DEBUG - Найдены заголовки таблицы: ['АИ-92', 'АИ-95', 'АИ-98', 'ДТ', 'Пропан']
2024-01-15 14:30:23 - DEBUG - Найдена строка с ценами, ячеек: 6
2024-01-15 14:30:23 - INFO - Извлечены цены через специальные селекторы russiabase.ru: {'АИ-92': 58.16, 'АИ-95': 59.12}
```

## Поддержка

При возникновении проблем:

1. Проверьте логи для диагностики
2. Убедитесь в актуальности селекторов сайта
3. Проверьте соединение с интернетом
4. Используйте тестовый скрипт для проверки функциональности