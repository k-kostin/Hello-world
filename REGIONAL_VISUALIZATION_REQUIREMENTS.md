# Требования к полным выгрузкам для визуализации карт

## Обзор изменений

Система визуализации теперь работает **ТОЛЬКО** с полными выгрузками региональных цен. Частичные выгрузки отклоняются для обеспечения полноты данных на картах.

## Система именования файлов

### ✅ Файлы, подходящие для визуализации

**Паттерн:** `all_regions_YYYYMMDD_HHMMSS.json`

**Требования:**
- ≥80 успешно обработанных регионов из ~85 возможных
- Полная выгрузка всех доступных регионов России
- Только эти файлы используются для создания карт

**Пример:** `all_regions_20250107_143055.json`

### ❌ Файлы, НЕ подходящие для визуализации

1. **Крупные выгрузки:** `regions_75of85_YYYYMMDD_HHMMSS.json`
   - 60-79 регионов (недостаточно для полной карты)

2. **Частичные выгрузки:** `regions_partial_25reg_YYYYMMDD_HHMMSS.json`
   - <60 регионов (слишком мало данных)

3. **Устаревшие файлы:** `regional_prices_YYYYMMDD_HHMMSS.json`
   - Старый формат именования (может быть неполным)

## Изменения в коде

### 1. Обновленное сохранение данных (`regional_parser.py`)

```python
# Новая система именования на основе количества регионов
if successful_count >= 80:  # 95%+ регионов
    prefix = f"all_regions"           # Для визуализации
    file_type = "ПОЛНАЯ"
elif successful_count >= 60:  # 70%+ регионов  
    prefix = f"regions_{successful_count}of{total_expected_regions}"
    file_type = "КРУПНАЯ"
else:  # Частичная выгрузка
    prefix = f"regions_partial_{successful_count}reg"
    file_type = "ЧАСТИЧНАЯ"
```

### 2. Строгий поиск файлов (`run_visualization.py`, `unified_fuel_map.py`)

```python
# Ищет ТОЛЬКО полные выгрузки
patterns = [
    "all_regions_*.json",  # Только полные выгрузки (>=80 регионов)
]

min_required_regions = 80  # Строгое требование
```

### 3. Информативные сообщения

Система теперь четко объясняет пользователю:
- Почему нужна полная выгрузка
- Как её получить 
- Какие файлы не подходят и почему

## Как получить полную выгрузку

### Команда для полной выгрузки
```bash
python regional_parser.py --all-regions
```

### Что произойдет
1. Парсинг займет ~10-15 минут
2. Будет создан файл `all_regions_YYYYMMDD_HHMMSS.json`
3. Система подтвердит пригодность файла для визуализации

### Сообщения системы
```
[SAVE] Данные сохранены в JSON: all_regions_20250107_143055.json
[NAMING] Тип выгрузки: ПОЛНАЯ (82 из ~85 регионов)
[VISUALIZATION] ✅ Файл подходит для создания карт (полная выгрузка)
```

## Преимущества нового подхода

✅ **Качество карт:** Все регионы отображаются на карте

✅ **Полнота данных:** Пользователи видят цены по всей России

✅ **Предсказуемость:** Четкое понимание какие файлы работают

✅ **Соответствие ожиданиям:** Карта показывает полную картину цен

## Обработка ошибок

### Если нет полной выгрузки
- Визуализация НЕ запускается
- Показывается четкая инструкция по получению полных данных
- Перечисляются найденные частичные файлы (для информации)

### Если есть только частичные выгрузки
- Система покажет список неподходящих файлов
- Объяснит почему они не подходят
- Даст инструкцию по получению полной выгрузки

## Совместимость

- Старые файлы `regional_prices_*.json` по-прежнему читаются
- Но для визуализации принимаются только файлы `all_regions_*.json`
- Система автоматически определяет полноту выгрузки по количеству регионов

## Техническая реализация

### Функции поиска файлов
- Ищут только паттерн `all_regions_*.json`
- Проверяют минимум 80 регионов в файле
- Отклоняют файлы с недостаточным количеством данных

### Логирование
- Подробная информация о найденных/отклоненных файлах
- Четкие инструкции для пользователя
- Статистика по количеству регионов

Система теперь гарантирует, что карты создаются только на основе полных и качественных данных о ценах на топливо по всей России.